var eMusicality;(function(n){function h(){let n=function(n,t){n.when("/home",{templateUrl:"home.html",controller:i.Controller,controllerAs:"ctrl"}).when("/player/:songId",{templateUrl:"player.html",controller:r.Controller,controllerAs:"ctrl"}).otherwise({redirectTo:"/home"}).caseInsensitiveMatch=!0;t.debugEnabled(s)};return n.$inject=["$routeProvider","$logProvider"],n}function c(){let n=function(){};return n.$inject=[],n}function u(t){return n.sixteen.slice(0,t)}function t(n){n&&(n.preventDefault(),n.stopPropagation())}const s=!0;n.config=h;n.run=c;let i;(function(n){class t{constructor(n,t){this.songs=[];t.$on("$routeChangeSuccess",function(){});n.songs().then(n=>{this.songs=n})}$postLink(){}}t.$inject=["$emu","$scope"];n.Controller=t})(i||(i={}));let r;(function(n){class i{constructor(n,t,i,r,u,f){this.$tone=t;this.$scope=i;this.$timeout=f;this.volumes=[{value:"mute",faIcon:"fa-volume-off"},{value:"normal",faIcon:"fa-volume-down"},{value:"boost",faIcon:"fa-volume-up"}];n.songs().then(n=>{this.song=n[parseInt(r.songId)],angular.isUndefined(this.song)&&u.path("/home"),t.load(this.song)})}get loaded(){return this.$tone.isLoaded}get beatIndex(){return Tone.Transport.seconds<this.song.offset?0:Math.round((Tone.Transport.seconds-this.song.offset)/this.$tone.secondsPerBeat)+1}get section(){for(var n=this.song.sections.length-1;n>0;n--)if(this.song.sections[n].startIndex<=this.beatIndex)break;return this.song.sections[n]}get oddPhrase(){return this.section.bars%2==1}get measures(){return Math.ceil(this.section.bars/2)}get measure(){return Math.floor((this.beatIndex-(this.section.startIndex||1))/8)+1||1}get measureMarkers(){return u(this.measures)}get beats(){return this.oddPhrase&&this.measure===this.measures?4:8}get beat(){return(this.beatIndex-(this.section.startIndex||1))%this.beats+1}get beatMarkers(){return u(this.beats)}volumeBtnClass(n,t){let i={};return n.volume===t.value?i["btn-info"]=!0:i["btn-outline-info"]=!0,i}setVolume(n,t,i){this.$tone.setVolume(n,t,i)}secondsAtBeatIndex(n){return n===0?0:60/this.song.bpm*(n-1)+this.song.offset}goToBeatIndex(n){n===0?this.playing?(Tone.Transport.stop(),this.$timeout(250).then(()=>{Tone.Transport.start()})):Tone.Transport.stop():Tone.Transport.seconds=new Tone.Time(Math.floor(n/4)+":"+(n-1)%4).toSeconds()+this.song.offset}restart(n){t(n);this.goToBeatIndex(0)}back(n){t(n);this.measure>1?this.goToBeatIndex(this.section.startIndex):this.section.previous()&&this.goToBeatIndex(this.section.previous().startIndex)}next(n){t(n);this.section.next()&&this.goToBeatIndex(this.section.next().startIndex)}get playing(){return Tone.Transport.state==="started"}toggle(){Tone.start();Tone.Transport.state==="started"?Tone.Transport.pause():Tone.Transport.start()}$postLink(){}}i.$inject=["$emu","$tone","$scope","$routeParams","$location","$timeout"];n.Controller=i})(r||(r={}));let l;(function(n){class t{constructor(n,t){this.$http=n;this.$q=t;this._loaded=!1;this._songs=[]}songs(){let n=this.$q.defer();return this._loaded?n.resolve(this._songs):this.$http.get("songs/songs.json").then(t=>{angular.forEach(t.data,n=>{new f(this._songs,n)}),this._loaded=!0,n.resolve(this._songs)}),n.promise}}t.$inject=["$http","$q"];n.Service=t})(l=n.Playlist||(n.Playlist={}));let a;(function(n){class i{constructor(n,t){this.$rootScope=n;this.$timeout=t;this._players=[];this._events=[];n.$on("$routeChangeSuccess",()=>{this.stop()})}get isPlaying(){return Tone.Transport.state==="started"}play(){Tone.start();this.isPlaying||Tone.Transport.start()}pause(){this.isPlaying&&Tone.Transport.pause()}stop(){Tone.Transport.stop()}get isLoaded(){var t,n;if(!this._players.length)return!1;for(t=!0,n=0;n<this._players.length;n++)if(!this._players[n].loaded){t=!1;break}return t}unload(){for(this.stop();this._players.length;)this._players.pop().dispose();while(this._events.length)Tone.Transport.clear(this._events.pop())}load(n){this.unload();Tone.Transport.bpm.value=n.bpm;this._secondsPerBeat=new Tone.Time("4n").toSeconds();angular.forEach(n.tracks,n=>{var t=new Tone.Player(n.audioUrl,()=>{this.$rootScope.$apply()});t.sync().start(n.offset).toMaster();t.volume.value=n.volumeNormal;this._players.push(t)});this._events.push(Tone.Transport.scheduleRepeat(n=>{Tone.Draw.schedule(()=>{this.$rootScope.$apply()},n)},"4n",n.offset,(n.endIndex-2)*this.secondsPerBeat+n.offset));this._events.push(Tone.Transport.scheduleOnce(n=>{Tone.Draw.schedule(()=>{this.stop(),this.$rootScope.$apply()},n)},(n.endIndex-1)*this.secondsPerBeat+n.offset))}setVolume(n,i,r){t(r);let u=this._players[n.id];switch(i.value){case"mute":u.mute=!0;break;case"normal":u.mute=!1;u.volume.value=n.volumeNormal;break;case"boost":u.mute=!1;u.volume.value=n.volumeBoost}n.volume=i.value}get secondsPerBeat(){return this._secondsPerBeat}}i.$inject=["$rootScope","$timeout"];n.Service=i})(a=n.ToneHandler||(n.ToneHandler={}));class f{constructor(n,t){this._songs=n;this.tracks=[];this.sections=[];this._songs.push(this);this.title=t.title;this.artist=t.artist;this.imageUrl="songs/"+this.id+"/"+t.imageUrl;this.downloadUrl=t.downloadUrl||null;this.bpm=t.bpm;this.offset=t.offset||0;angular.forEach(t.tracks,n=>{new e(this.id,this.tracks,n)});angular.forEach(t.sections,n=>{new o(this.sections,n)});this.endIndex=this.sections[this.sections.length-1].startIndex+this.sections[this.sections.length-1].bars*4}get id(){return this._songs.indexOf(this)}get multitrack(){return this.tracks.length>1}}n.Song=f;class e{constructor(n,t,i){this._tracks=t;this._tracks.push(this);this.description=i.description;this.audioUrl="songs/"+n+"/"+i.audioUrl;this.offset=i.offset||0;this.volumeNormal=i.volumeNormal||-10;this.volumeBoost=i.volumeBoost||0;this.volume="normal"}get id(){return this._tracks.indexOf(this)}}n.Track=e;class o{constructor(n,t){if(this._sections=n,n.push(this),this.description=t.description,this.structure=t.structure,this.bars=t.bars,this.id===0)this.startIndex=0;else{let n=this._sections[this.id-1];this.startIndex=(n.startIndex||1)+n.bars*4}}get id(){return this._sections.indexOf(this)}previous(){if(this.id!==0)return this._sections[this.id-1]}next(){if(!(this.id+1>=this._sections.length))return this._sections[this.id+1]}}n.Section=o;n.sixteen=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];n.markers=u;n.cancel=t})(eMusicality||(eMusicality={}));angular.module("emusicality",["ngRoute","ngSanitize"]).config(eMusicality.config()).run(eMusicality.run()).service("$emu",eMusicality.Playlist.Service).service("$tone",eMusicality.ToneHandler.Service);